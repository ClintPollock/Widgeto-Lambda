name: Britive Federated AWS Access via Credential Process

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  federated-aws-access:
    runs-on: ubuntu-latest

    env:
      BRITIVE_TENANT: se-learn  # use lowercase here as pybritive normalizes it
      BRITIVE_PROFILE_NAME: AWS Standalone/Widgeto Prod/Widgeto-App-S3-Prod-Access
      FED_PROVIDER: github
      AWS_REGION: us-east-2   # adjust if needed
      S3_BUCKET_NAME: your-bucket-name

    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install pybritive and AWS CLI
        run: |
          pip install pybritive --quiet
          pip install awscli --quiet

      - name: Configure Britive and AWS credential_process
        run: |
          mkdir -p ~/.aws

          # Configure Britive tenant
          # pybritive configure tenant --tenant "$BRITIVE_TENANT" --no-prompt
          # pybritive configure global --tenant "$BRITIVE_TENANT" --format json --no-prompt

          # Add profile alias
          # pybritive configure update profile-aliases default "$BRITIVE_PROFILE_NAME"

          pybritive checkout "AWS Standalone/Widgeto Prod/Widgeto-App-S3-Prod-Access" -t SE-Learn --federation-provider github-britive

          # Set AWS credential_process to use pybritive federation
          cat <<EOF > ~/.aws/credentials
          [default]
          credential_process=pybritive checkout default -m awscredentialprocess -P $FED_PROVIDER
          EOF

          # Set default AWS region
          aws configure set default.region "$AWS_REGION"

      - name: Test AWS Access - List S3 Buckets
        run: |
          echo "Listing S3 buckets..."
          aws s3 ls

      - name: Test AWS Access - List a specific bucket
        run: |
          echo "Listing contents of bucket: $S3_BUCKET_NAME"
          aws s3 ls "s3://$S3_BUCKET_NAME"
